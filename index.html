<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

</head>
<body>
    
    <nav class="navbar navbar-light bg-light">
        <div class="container-fluid">
            <a class="navbar-brand">ðŸ”Ž Buscador de Intereses</a>

            <form class="d-flex" onsubmit="return false">
                <select class="form-select" aria-label="50" id="limit">
                    <option value="50" selected>50</option>
                    <option value="100">100</option>
                    <option value="250">250</option>
                    <option value="500">500</option>
                    <option value="1000">1000</option>
                    <option value="2500">2500</option>
                    <option value="+5000">+5000</option>
                </select>_
                <select class="form-select" aria-label="es_CO" id="searchIdioma">
                    <option value="es_CO" selected>es_CO</option>
                    <option value="es_US">es_US</option>
                    <option value="en_US">en_US</option>
                    <option value="es_ES">es_ES</option>
                    <option value="es_PA">es_PA</option>
                </select>_ 
                <input class="form-control form-x me-2" type="text" placeholder="Interes que buscas" aria-label="Search" onkeydown="searchKey()" id="txtSearchs">
                <button class="btn btn-outline-success" type="button" id="buscarInteres">Search</button>
            </form>
        </div>
    </nav>

    <br>
    <div class="container">
        <section class="row">
            <div class="col" id="liveAlertPlaceholder"></div>
        </section>
    </div>
    <div class="container" style="padding: 25px 0px">
        <section class="row-xl">
            <input class="form-control" type="search" placeholder="Token Api" aria-label="api" id="tokenApiFb" onkeydown="searchKey()">
        </section>
    </div>
    <div class="container">
        <section class="row">
            <table class="table table-striped table-hover" id="resultados" style="overflow-y: auto">
                <thead>
                    <tr>
                        <th scope="col">ID#</th>
                        <th scope="col">Nombre</th>
                        <th scope="col">Audiencia Min</th>
                        <th scope="col">Audiencia Max</th>
                        <th scope="col">Tema</th>
                        <th scope="col">Ruta</th>
                        <th scope="col">DescripciÃ³n</th>
                    </tr>
                </thead>
                <tbody id="contentResultados">
                </tbody>
            </table>
        </section>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.slim.min.js" integrity="sha256-u7e5khyithlIdTpu22PHhENmPcRdFiHRjhAuHcs05RI=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

    <script>
        let btnBuscarI = $('#buscarInteres');
        let saveToken = localStorage.getItem('tokenApiFb');
        let ultimaBusqueda = localStorage.getItem('BuscandoTxt');
        var lls = null;
        
        btnBuscarI.click(buscar);

        if(saveToken === null) {
            alertPlaceHolder('danger', 'Falta el token para realizar la consulta. link: <a href="https://developers.facebook.com/tools/explorer" target="_blank">Generar Token</a>')
        }else{
            $('#tokenApiFb').val(saveToken);
        }

        if(ultimaBusqueda !== null) {
            $('#txtSearchs').val(ultimaBusqueda);
        }else{
            localStorage.setItem('BuscandoTxt', null);
        }

        function searchKey(e){
            e = e || window.event;
            if(e.keyCode == 13) {
                var elem = e.srcElement || e.target;
                buscar();
            }
        }

        function buscar(e, txtBuscar){
            let busqueda = $('#txtSearchs').val();
            let token = $('#tokenApiFb').val();
            let limit = $('#limit').val();
            let idioma = $('#searchIdioma').val();

            let urlApi = `https://graph.facebook.com/search?type=adinterest&q=[${busqueda}]&limit=${Number(limit)}&locale=${idioma}&access_token=${token}`;
            fetch(urlApi)
                .then(response => response.json())
                .then(json => responseOk(json))
        }

        function responseOk(rsp){
            if(rsp.error) {errorJson(rsp);}
            console.info(rsp)
            lls = rsp;

            // Guardar token
            let token = $('#tokenApiFb').val();
            let txtSearch = $('#txtSearchs').val();
            localStorage.setItem('tokenApiFb', token);
            localStorage.setItem('BuscandoTxt', txtSearch);

            // Limpiando Tabla
            $('#contentResultados')[0].innerHTML = "";

            // Alert 
            closeAlert('info', 0);
            alertPlaceHolder('info', `Buscando: ${localStorage.getItem('BuscandoTxt')} -> Cantidad de  Resultados: ${rsp.data.length}`)

            // Enviando
            rsp.data.forEach((el,idx) => {
                printTableResult(idx,el);
            })
        }

        function closeAlert(alert,cant) {
            let alertHtml = $(`.alert-${alert}`);
            let alertPlaceholder = $('#liveAlertPlaceholder')[0];
            
            if (alertHtml.length > cant) {
                alertPlaceholder.innerHTML ="";
            }
            return false;
        }

        function printTableResult(idx, data) {
            let idioma = $('#searchIdioma').val();
            let contentTable = $('#contentResultados');
            let wrapper = document.createElement('tr');
            contentTable[0]
            wrapper.setAttribute('id', data.id);
            wrapper.innerHTML = `<th scope="row" aria-label="${data.id}" abbr="${data.id}">${idx+1}</th>
                <td>${data.name}</td>
                <td>${new Intl.NumberFormat(idioma.replace('_','-')).format(data.audience_size_lower_bound)}</td>
                <td>${new Intl.NumberFormat(idioma.replace('_','-')).format(data.audience_size_upper_bound)}</td>
                <td>${data.topic}</td>
                <td>${String(data.path).replaceAll(',', ' > ')}</td>
                <td>${data.description === null ? "" : data.description}</td>
                `;

            contentTable.append(wrapper);
        }

        function errorJson(err){
            // alert(`Error en la consulta: ${err.error.message}`);
            closeAlert('danger',2);
            alertPlaceHolder('danger', `${err.error.message} -><a href="https://developers.facebook.com/tools/explorer" target="_blank">Generar Nuevo Token</a>`);
        }

        function alertPlaceHolder(t, m){
            let alertPlaceholder = $('#liveAlertPlaceholder');
            let wrapper = document.createElement('div');
            let message = m;
            let type = t;

            wrapper.innerHTML = '<div class="alert alert-' + type + ' alert-dismissible" role="alert">' + message + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>';
            
            alertPlaceholder.append(wrapper)
        }
        
    </script>
</body>
</html>